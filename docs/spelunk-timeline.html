<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spelunk - Losselot History Explorer</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a1a;
            color: #e0e0e0;
            min-height: 100vh;
        }

        header {
            background: #12122a;
            padding: 20px 30px;
            border-bottom: 1px solid #1e1e3f;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        header h1 { font-size: 24px; color: #fff; }
        header .subtitle { color: #888; font-size: 14px; }
        .nav-links { margin-left: auto; display: flex; gap: 15px; }
        .nav-links a { color: #60a5fa; text-decoration: none; font-size: 14px; }
        .nav-links a:hover { text-decoration: underline; }

        .controls {
            background: #12122a;
            padding: 15px 30px;
            border-bottom: 1px solid #1e1e3f;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group label { color: #888; font-size: 13px; }
        select, input[type="text"] {
            background: #1a1a2e;
            border: 1px solid #2a2a4a;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
        }
        .toggle-btn {
            background: #1a1a2e;
            border: 1px solid #2a2a4a;
            color: #888;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .toggle-btn.active { background: #3b82f6; border-color: #3b82f6; color: #fff; }
        .toggle-btn:hover { border-color: #3b82f6; }

        .main-container {
            display: flex;
            height: calc(100vh - 130px);
        }

        .timeline-panel {
            flex: 2;
            overflow-y: auto;
            padding: 20px;
            border-right: 1px solid #1e1e3f;
        }

        .detail-panel {
            flex: 1;
            min-width: 350px;
            overflow-y: auto;
            padding: 20px;
            background: #0f0f1f;
        }

        .timeline-item {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 19px;
            top: 40px;
            bottom: -20px;
            width: 2px;
            background: linear-gradient(to bottom, #3b82f6, #1e1e3f);
        }
        .timeline-item:last-child::before { display: none; }

        .timeline-marker {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            z-index: 1;
        }
        .marker-commit { background: #1e3a5f; border: 2px solid #3b82f6; }
        .marker-decision { background: #3f2e1e; border: 2px solid #eab308; }
        .marker-action { background: #3f1e1e; border: 2px solid #ef4444; }
        .marker-outcome { background: #2e1e3f; border: 2px solid #a855f7; }
        .marker-observation { background: #2a2a3a; border: 2px solid #6b7280; }
        .marker-goal { background: #1e3f2e; border: 2px solid #22c55e; }

        .timeline-content {
            flex: 1;
            background: #16162e;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #2a2a4a;
            cursor: pointer;
            transition: all 0.2s;
        }
        .timeline-content:hover { border-color: #3b82f6; }
        .timeline-content.selected { border-color: #3b82f6; background: #1a1a3a; }

        .timeline-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .timeline-type {
            font-size: 10px;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        .type-commit { background: #3b82f633; color: #60a5fa; }
        .type-decision { background: #eab30833; color: #fbbf24; }
        .type-action { background: #ef444433; color: #f87171; }
        .type-outcome { background: #a855f733; color: #c084fc; }
        .type-observation { background: #6b728033; color: #9ca3af; }
        .type-goal { background: #22c55e33; color: #4ade80; }
        .type-option { background: #06b6d433; color: #22d3ee; }

        .confidence-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }
        .conf-high { background: #22c55e33; color: #4ade80; }
        .conf-med { background: #eab30833; color: #fbbf24; }
        .conf-low { background: #ef444433; color: #f87171; }

        .commit-hash {
            font-family: monospace;
            font-size: 12px;
            color: #60a5fa;
            text-decoration: none;
        }
        .commit-hash:hover { text-decoration: underline; }

        .timeline-title { font-size: 14px; color: #fff; line-height: 1.4; }
        .timeline-meta { font-size: 12px; color: #666; margin-top: 6px; }

        .linked-nodes {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #2a2a4a;
        }
        .linked-label { font-size: 11px; color: #888; margin-bottom: 6px; }
        .linked-node {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #1a1a2e;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            margin-right: 6px;
            margin-bottom: 4px;
        }

        .detail-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }

        .detail-header {
            margin-bottom: 20px;
        }
        .detail-header h2 { font-size: 18px; margin-bottom: 10px; }
        .detail-badges { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }

        .detail-section {
            background: #16162e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .detail-section h3 {
            font-size: 13px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .detail-section p { font-size: 14px; line-height: 1.5; }

        .connection-list { list-style: none; }
        .connection-list li {
            padding: 8px 0;
            border-bottom: 1px solid #2a2a4a;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        .connection-list li:hover { color: #60a5fa; }
        .connection-list li:last-child { border: none; }

        .edge-type {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }
        .edge-leads_to { background: #3b82f633; color: #60a5fa; }
        .edge-chosen { background: #22c55e33; color: #4ade80; }
        .edge-rejected { background: #ef444433; color: #f87171; }
        .edge-requires { background: #eab30833; color: #fbbf24; }

        .stats-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            flex: 1;
            background: #16162e;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-value { font-size: 28px; font-weight: 700; color: #fff; }
        .stat-label { font-size: 12px; color: #888; margin-top: 4px; }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #888;
        }
    </style>
</head>
<body>
    <header>
        <h1>ðŸ”¦ Spelunk</h1>
        <span class="subtitle">Explore how Losselot came to be</span>
        <div class="nav-links">
            <a href="./">Home</a>
            <a href="demo/">Decision Graph</a>
            <a href="analyzer.html">Analyzer</a>
        </div>
    </header>

    <div class="controls">
        <div class="control-group">
            <label>Show:</label>
            <button class="toggle-btn active" data-filter="all">All</button>
            <button class="toggle-btn" data-filter="commits">Commits</button>
            <button class="toggle-btn" data-filter="decisions">Decisions</button>
            <button class="toggle-btn" data-filter="linked">Linked Only</button>
        </div>
        <div class="control-group">
            <label>Search:</label>
            <input type="text" id="search" placeholder="Filter by text...">
        </div>
        <div class="control-group" style="margin-left: auto;">
            <span id="item-count" style="color: #888; font-size: 13px;"></span>
        </div>
    </div>

    <div class="main-container">
        <div class="timeline-panel" id="timeline">
            <div class="loading">Loading history...</div>
        </div>
        <div class="detail-panel" id="detail">
            <div class="detail-empty">Select an item to see details</div>
        </div>
    </div>

    <script>
        let graphData = null;
        let gitHistory = [];
        let mergedTimeline = [];
        let selectedItem = null;
        let currentFilter = 'all';

        // Fetch decision graph
        async function loadGraph() {
            try {
                const res = await fetch('demo/graph-data.json');
                graphData = await res.json();
                return true;
            } catch (e) {
                console.error('Failed to load graph:', e);
                return false;
            }
        }

        // Generate git history from embedded data (we'll fetch this)
        async function loadGitHistory() {
            try {
                const res = await fetch('git-history.json');
                gitHistory = await res.json();
                return true;
            } catch (e) {
                console.warn('git-history.json not found, generating from known commits');
                // Fallback: extract commits from decision nodes that have commit links
                gitHistory = [];
                return false;
            }
        }

        function getConfidence(node) {
            if (!node.metadata_json) return null;
            try {
                return JSON.parse(node.metadata_json).confidence;
            } catch { return null; }
        }

        function getCommit(node) {
            if (!node.metadata_json) return null;
            try {
                return JSON.parse(node.metadata_json).commit || null;
            } catch { return null; }
        }

        function mergeTimelines() {
            mergedTimeline = [];

            // Add decision nodes
            graphData.nodes.forEach(node => {
                mergedTimeline.push({
                    type: 'decision',
                    nodeType: node.node_type,
                    id: node.id,
                    title: node.title,
                    description: node.description,
                    date: new Date(node.created_at),
                    confidence: getConfidence(node),
                    commit: getCommit(node),
                    status: node.status,
                    node: node
                });
            });

            // Add git commits
            gitHistory.forEach(commit => {
                // Check if any decision node links to this commit
                const linkedNodes = graphData.nodes.filter(n => {
                    const c = getCommit(n);
                    return c && (c === commit.hash || c === commit.short || commit.hash.startsWith(c));
                });

                mergedTimeline.push({
                    type: 'commit',
                    nodeType: 'commit',
                    id: commit.hash,
                    short: commit.short,
                    title: commit.subject,
                    author: commit.author,
                    date: new Date(commit.date),
                    linkedNodes: linkedNodes
                });
            });

            // Sort by date descending
            mergedTimeline.sort((a, b) => b.date - a.date);
        }

        function filterTimeline() {
            const searchTerm = document.getElementById('search').value.toLowerCase();

            return mergedTimeline.filter(item => {
                // Filter by type
                if (currentFilter === 'commits' && item.type !== 'commit') return false;
                if (currentFilter === 'decisions' && item.type === 'commit') return false;
                if (currentFilter === 'linked') {
                    if (item.type === 'commit' && (!item.linkedNodes || item.linkedNodes.length === 0)) return false;
                    if (item.type === 'decision' && !item.commit) return false;
                }

                // Search filter
                if (searchTerm) {
                    const text = (item.title + ' ' + (item.description || '')).toLowerCase();
                    if (!text.includes(searchTerm)) return false;
                }

                return true;
            });
        }

        function renderTimeline() {
            const container = document.getElementById('timeline');
            const filtered = filterTimeline();

            document.getElementById('item-count').textContent = `${filtered.length} items`;

            if (filtered.length === 0) {
                container.innerHTML = '<div class="loading">No items match your filter</div>';
                return;
            }

            let currentDate = null;
            let html = '';

            filtered.forEach(item => {
                const dateStr = item.date.toLocaleDateString('en-US', {
                    weekday: 'short', month: 'short', day: 'numeric'
                });

                if (dateStr !== currentDate) {
                    currentDate = dateStr;
                    html += `<div style="color: #666; font-size: 12px; margin: 20px 0 10px 55px; text-transform: uppercase;">${dateStr}</div>`;
                }

                const isSelected = selectedItem && selectedItem.id === item.id ? 'selected' : '';
                const markerClass = item.type === 'commit' ? 'marker-commit' : `marker-${item.nodeType}`;
                const icon = item.type === 'commit' ? 'â¬¡' : getNodeIcon(item.nodeType);

                html += `
                    <div class="timeline-item" data-id="${item.id}" data-type="${item.type}">
                        <div class="timeline-marker ${markerClass}">${icon}</div>
                        <div class="timeline-content ${isSelected}">
                            <div class="timeline-header">
                                <span class="timeline-type type-${item.nodeType}">${item.type === 'commit' ? 'commit' : item.nodeType}</span>
                                ${item.confidence !== null ? `<span class="confidence-badge ${getConfLevel(item.confidence)}">${item.confidence}%</span>` : ''}
                                ${item.type === 'commit' ? `<a class="commit-hash" href="https://github.com/notactuallytreyanastasio/losselot/commit/${item.id}" target="_blank">${item.short}</a>` : ''}
                                ${item.commit ? `<a class="commit-hash" href="https://github.com/notactuallytreyanastasio/losselot/commit/${item.commit}" target="_blank">${item.commit.slice(0,7)}</a>` : ''}
                            </div>
                            <div class="timeline-title">${item.title}</div>
                            <div class="timeline-meta">
                                ${item.date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                                ${item.author ? ` Â· ${item.author}` : ''}
                            </div>
                            ${item.linkedNodes && item.linkedNodes.length > 0 ? `
                                <div class="linked-nodes">
                                    <div class="linked-label">Linked decisions:</div>
                                    ${item.linkedNodes.map(n => `
                                        <span class="linked-node">
                                            <span class="timeline-type type-${n.node_type}" style="padding: 1px 4px; font-size: 9px;">${n.node_type}</span>
                                            ${truncate(n.title, 30)}
                                        </span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Add click handlers
            container.querySelectorAll('.timeline-item').forEach(el => {
                el.addEventListener('click', () => {
                    const id = el.dataset.id;
                    const type = el.dataset.type;
                    selectedItem = mergedTimeline.find(i => String(i.id) === id);
                    renderTimeline();
                    renderDetail();
                });
            });
        }

        function renderDetail() {
            const panel = document.getElementById('detail');

            if (!selectedItem) {
                panel.innerHTML = '<div class="detail-empty">Select an item to see details</div>';
                return;
            }

            const item = selectedItem;

            if (item.type === 'commit') {
                panel.innerHTML = `
                    <div class="detail-header">
                        <div class="detail-badges">
                            <span class="timeline-type type-commit">commit</span>
                            <a class="commit-hash" href="https://github.com/notactuallytreyanastasio/losselot/commit/${item.id}" target="_blank">${item.short}</a>
                        </div>
                        <h2>${item.title}</h2>
                        <p style="color: #888; font-size: 13px;">${item.author} Â· ${item.date.toLocaleString()}</p>
                    </div>

                    <div class="detail-section">
                        <h3>View on GitHub</h3>
                        <p><a href="https://github.com/notactuallytreyanastasio/losselot/commit/${item.id}" target="_blank" style="color: #60a5fa;">See full diff and changes â†’</a></p>
                    </div>

                    ${item.linkedNodes && item.linkedNodes.length > 0 ? `
                        <div class="detail-section">
                            <h3>Linked Decisions (${item.linkedNodes.length})</h3>
                            <ul class="connection-list">
                                ${item.linkedNodes.map(n => `
                                    <li onclick="selectNode(${n.id})">
                                        <span class="timeline-type type-${n.node_type}">${n.node_type}</span>
                                        <span>${n.title}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : `
                        <div class="detail-section">
                            <h3>No Linked Decisions</h3>
                            <p style="color: #888;">This commit doesn't have any decision nodes linked to it yet.</p>
                        </div>
                    `}
                `;
            } else {
                const node = item.node;
                const incoming = graphData.edges.filter(e => e.to_node_id === node.id);
                const outgoing = graphData.edges.filter(e => e.from_node_id === node.id);

                const getNodeTitle = (id) => {
                    const n = graphData.nodes.find(x => x.id === id);
                    return n ? n.title : 'Unknown';
                };
                const getNodeType = (id) => {
                    const n = graphData.nodes.find(x => x.id === id);
                    return n ? n.node_type : 'unknown';
                };

                panel.innerHTML = `
                    <div class="detail-header">
                        <div class="detail-badges">
                            <span class="timeline-type type-${node.node_type}">${node.node_type}</span>
                            ${item.confidence !== null ? `<span class="confidence-badge ${getConfLevel(item.confidence)}">${item.confidence}%</span>` : ''}
                            ${item.commit ? `<a class="commit-hash" href="https://github.com/notactuallytreyanastasio/losselot/commit/${item.commit}" target="_blank">${item.commit.slice(0,7)}</a>` : ''}
                        </div>
                        <h2>${node.title}</h2>
                        <p style="color: #888; font-size: 13px;">Node #${node.id} Â· ${item.date.toLocaleString()}</p>
                    </div>

                    ${node.description ? `
                        <div class="detail-section">
                            <h3>Description</h3>
                            <p>${node.description}</p>
                        </div>
                    ` : ''}

                    ${incoming.length > 0 ? `
                        <div class="detail-section">
                            <h3>Incoming Connections (${incoming.length})</h3>
                            <ul class="connection-list">
                                ${incoming.map(e => `
                                    <li onclick="selectNode(${e.from_node_id})">
                                        <span class="edge-type edge-${e.edge_type}">${e.edge_type}</span>
                                        <span class="timeline-type type-${getNodeType(e.from_node_id)}" style="font-size: 9px; padding: 1px 4px;">${getNodeType(e.from_node_id)}</span>
                                        <span>${truncate(getNodeTitle(e.from_node_id), 40)}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${outgoing.length > 0 ? `
                        <div class="detail-section">
                            <h3>Outgoing Connections (${outgoing.length})</h3>
                            <ul class="connection-list">
                                ${outgoing.map(e => `
                                    <li onclick="selectNode(${e.to_node_id})">
                                        <span class="edge-type edge-${e.edge_type}">${e.edge_type}</span>
                                        <span class="timeline-type type-${getNodeType(e.to_node_id)}" style="font-size: 9px; padding: 1px 4px;">${getNodeType(e.to_node_id)}</span>
                                        <span>${truncate(getNodeTitle(e.to_node_id), 40)}</span>
                                        ${e.rationale ? `<span style="color: #666; font-size: 11px; margin-left: auto;">${e.rationale}</span>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;
            }
        }

        function selectNode(nodeId) {
            selectedItem = mergedTimeline.find(i => i.type === 'decision' && i.id === nodeId);
            renderTimeline();
            renderDetail();

            // Scroll to item
            const el = document.querySelector(`.timeline-item[data-id="${nodeId}"]`);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function getNodeIcon(type) {
            const icons = {
                goal: 'ðŸŽ¯',
                decision: 'ðŸ¤”',
                option: 'ðŸ’¡',
                action: 'âš¡',
                outcome: 'âœ…',
                observation: 'ðŸ‘'
            };
            return icons[type] || 'â€¢';
        }

        function getConfLevel(conf) {
            if (conf >= 70) return 'conf-high';
            if (conf >= 40) return 'conf-med';
            return 'conf-low';
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.slice(0, len) + '...' : str;
        }

        // Filter button handlers
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderTimeline();
            });
        });

        // Search handler
        document.getElementById('search').addEventListener('input', () => {
            renderTimeline();
        });

        // Initialize
        async function init() {
            await loadGraph();
            await loadGitHistory();
            mergeTimelines();
            renderTimeline();
        }

        init();
    </script>
</body>
</html>

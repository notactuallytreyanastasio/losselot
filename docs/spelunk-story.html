<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spelunk - The Losselot Story</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Georgia', serif;
            background: #0a0a1a;
            color: #d0d0d0;
            line-height: 1.7;
        }

        header {
            background: linear-gradient(135deg, #0f0f2a 0%, #1a1a3a 100%);
            padding: 60px 20px;
            text-align: center;
            border-bottom: 1px solid #2a2a4a;
        }
        header h1 {
            font-size: 48px;
            font-weight: 400;
            margin-bottom: 15px;
            color: #fff;
        }
        header .subtitle {
            font-size: 20px;
            color: #888;
            max-width: 600px;
            margin: 0 auto;
        }
        .reading-time {
            margin-top: 20px;
            color: #666;
            font-size: 14px;
            font-family: -apple-system, sans-serif;
        }

        nav.toc {
            position: sticky;
            top: 0;
            background: rgba(10, 10, 26, 0.98);
            border-bottom: 1px solid #2a2a4a;
            padding: 15px 20px;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .toc-inner {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 20px;
            overflow-x: auto;
        }
        .toc-label {
            color: #888;
            font-size: 12px;
            font-family: -apple-system, sans-serif;
            text-transform: uppercase;
            white-space: nowrap;
        }
        .toc-link {
            color: #60a5fa;
            text-decoration: none;
            font-size: 14px;
            font-family: -apple-system, sans-serif;
            white-space: nowrap;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.2s;
        }
        .toc-link:hover { background: #1a1a3a; }
        .toc-link.active { background: #3b82f6; color: #fff; }

        main {
            max-width: 800px;
            margin: 0 auto;
            padding: 60px 20px;
        }

        .chapter {
            margin-bottom: 80px;
            scroll-margin-top: 80px;
        }
        .chapter-number {
            font-size: 14px;
            color: #3b82f6;
            font-family: -apple-system, sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }
        .chapter h2 {
            font-size: 32px;
            font-weight: 400;
            margin-bottom: 30px;
            color: #fff;
        }
        .chapter p {
            margin-bottom: 25px;
            font-size: 18px;
        }

        .decision-card {
            background: #12122a;
            border-left: 4px solid #eab308;
            padding: 25px 30px;
            margin: 30px 0;
            border-radius: 0 10px 10px 0;
        }
        .decision-card.chosen { border-color: #22c55e; }
        .decision-card.rejected { border-color: #ef4444; }
        .decision-card.action { border-color: #3b82f6; }
        .decision-card.outcome { border-color: #a855f7; }

        .decision-card h4 {
            font-family: -apple-system, sans-serif;
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .decision-card p {
            font-size: 16px;
            margin-bottom: 10px;
        }
        .decision-card .meta {
            font-size: 13px;
            color: #666;
            font-family: -apple-system, sans-serif;
        }
        .decision-card .confidence {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 10px;
        }
        .conf-high { background: #22c55e33; color: #4ade80; }
        .conf-med { background: #eab30833; color: #fbbf24; }
        .conf-low { background: #ef444433; color: #f87171; }

        .commit-ref {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #1a1a2e;
            padding: 4px 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
            color: #60a5fa;
            text-decoration: none;
            margin-top: 10px;
        }
        .commit-ref:hover { background: #2a2a4e; }

        .timeline-mini {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        .timeline-node {
            flex-shrink: 0;
            background: #16162e;
            padding: 15px;
            border-radius: 10px;
            min-width: 200px;
            border: 1px solid #2a2a4a;
        }
        .timeline-node .type {
            font-size: 10px;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: -apple-system, sans-serif;
            margin-bottom: 8px;
            display: inline-block;
        }
        .type-goal { background: #22c55e33; color: #4ade80; }
        .type-decision { background: #eab30833; color: #fbbf24; }
        .type-action { background: #ef444433; color: #f87171; }
        .type-outcome { background: #a855f733; color: #c084fc; }
        .timeline-node .title {
            font-size: 14px;
            color: #fff;
            font-family: -apple-system, sans-serif;
        }

        blockquote {
            border-left: 3px solid #3b82f6;
            padding-left: 20px;
            margin: 30px 0;
            font-style: italic;
            color: #999;
        }

        .stats-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 40px 0;
        }
        .stat-card {
            background: #12122a;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #fff;
            font-family: -apple-system, sans-serif;
        }
        .stat-label {
            font-size: 13px;
            color: #888;
            font-family: -apple-system, sans-serif;
        }

        footer {
            background: #0f0f1f;
            padding: 40px 20px;
            text-align: center;
            border-top: 1px solid #2a2a4a;
        }
        footer a {
            color: #60a5fa;
            text-decoration: none;
            margin: 0 15px;
            font-family: -apple-system, sans-serif;
        }
        footer a:hover { text-decoration: underline; }

        .loading { text-align: center; padding: 60px; color: #888; }

        @media (max-width: 600px) {
            .stats-section { grid-template-columns: repeat(2, 1fr); }
            header h1 { font-size: 32px; }
        }
    </style>
</head>
<body>
    <header>
        <h1>ðŸ”¦ The Losselot Story</h1>
        <p class="subtitle">How an audio forensics tool became a living experiment in AI-assisted development</p>
        <p class="reading-time" id="reading-time">Loading...</p>
    </header>

    <nav class="toc">
        <div class="toc-inner">
            <span class="toc-label">Chapters:</span>
            <a href="#prologue" class="toc-link">Prologue</a>
            <a href="#chapter-1" class="toc-link">The Beginning</a>
            <a href="#chapter-2" class="toc-link">Detection Algorithms</a>
            <a href="#chapter-3" class="toc-link">The Memory Problem</a>
            <a href="#chapter-4" class="toc-link">Living Museum</a>
            <a href="#epilogue" class="toc-link">What's Next</a>
        </div>
    </nav>

    <main id="content">
        <div class="loading">Loading story...</div>
    </main>

    <footer>
        <a href="./">Home</a>
        <a href="demo/">Decision Graph</a>
        <a href="analyzer.html">Analyzer</a>
        <a href="https://github.com/notactuallytreyanastasio/losselot">GitHub</a>
    </footer>

    <script>
        let graphData = null;

        async function loadGraph() {
            try {
                const res = await fetch('demo/graph-data.json');
                graphData = await res.json();
                renderStory();
            } catch (e) {
                document.getElementById('content').innerHTML = '<div class="loading">Failed to load story data</div>';
            }
        }

        function getConfidence(node) {
            if (!node.metadata_json) return null;
            try { return JSON.parse(node.metadata_json).confidence; } catch { return null; }
        }

        function getCommit(node) {
            if (!node.metadata_json) return null;
            try { return JSON.parse(node.metadata_json).commit || null; } catch { return null; }
        }

        function findNodes(filter) {
            return graphData.nodes.filter(filter).sort((a, b) =>
                new Date(a.created_at) - new Date(b.created_at)
            );
        }

        function renderDecisionCard(node, type = 'decision') {
            const conf = getConfidence(node);
            const commit = getCommit(node);
            const confLevel = conf >= 70 ? 'high' : conf >= 40 ? 'med' : 'low';

            return `
                <div class="decision-card ${type}">
                    <h4>${node.node_type}</h4>
                    <p><strong>${node.title}</strong></p>
                    ${node.description ? `<p style="color: #999;">${node.description}</p>` : ''}
                    <div class="meta">
                        ${new Date(node.created_at).toLocaleDateString()}
                        ${conf !== null ? `<span class="confidence conf-${confLevel}">${conf}% confidence</span>` : ''}
                    </div>
                    ${commit ? `<a href="https://github.com/notactuallytreyanastasio/losselot/commit/${commit}" target="_blank" class="commit-ref">ðŸ“Ž ${commit.slice(0,7)}</a>` : ''}
                </div>
            `;
        }

        function renderTimelineMini(nodes) {
            return `
                <div class="timeline-mini">
                    ${nodes.slice(0, 6).map(n => `
                        <div class="timeline-node">
                            <span class="type type-${n.node_type}">${n.node_type}</span>
                            <div class="title">${truncate(n.title, 50)}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function truncate(str, len) {
            return str.length > len ? str.slice(0, len) + '...' : str;
        }

        function renderStory() {
            // Get key nodes for different chapters
            const goals = findNodes(n => n.node_type === 'goal');
            const lofiNodes = findNodes(n => n.title.toLowerCase().includes('lofi') || n.title.toLowerCase().includes('cfcc') || n.title.toLowerCase().includes('lo-fi'));
            const graphNodes = findNodes(n => n.title.toLowerCase().includes('decision graph') || n.title.toLowerCase().includes('memory'));
            const wasmNodes = findNodes(n => n.title.toLowerCase().includes('wasm'));
            const recentActions = findNodes(n => n.node_type === 'action').slice(-5);

            const totalNodes = graphData.nodes.length;
            const totalEdges = graphData.edges.length;
            const withConfidence = graphData.nodes.filter(n => getConfidence(n) !== null).length;
            const withCommits = graphData.nodes.filter(n => getCommit(n) !== null).length;

            document.getElementById('reading-time').textContent = `${totalNodes} decisions documented Â· ~5 min read`;

            document.getElementById('content').innerHTML = `
                <section class="chapter" id="prologue">
                    <span class="chapter-number">Prologue</span>
                    <h2>The Question</h2>
                    <p>It started with a simple question: <em>Is this FLAC file actually lossless?</em></p>
                    <p>Somewhere on the internet, someone downloaded what they thought was a high-quality audio file. But behind the .flac extension, there was a secretâ€”the file had been transcoded from an MP3. The frequencies above 16kHz were gone, leaving only the scars of lossy compression.</p>
                    <p>Losselot was built to find these scars.</p>
                </section>

                <section class="chapter" id="chapter-1">
                    <span class="chapter-number">Chapter 1</span>
                    <h2>The Beginning</h2>
                    <p>The first commit was simple: FFT analysis to find frequency cutoffs. Lossy codecs remove high frequencies to save spaceâ€”128kbps MP3 cuts off around 16kHz, 320kbps around 20kHz.</p>
                    <p>But detection was crude. Too many false positives. Some legitimate lo-fi recordings looked like transcodes.</p>

                    ${goals.length > 0 ? `
                        <p>Early goals captured in the decision graph:</p>
                        ${renderTimelineMini(goals.slice(0, 4))}
                    ` : ''}
                </section>

                <section class="chapter" id="chapter-2">
                    <span class="chapter-number">Chapter 2</span>
                    <h2>The Lo-Fi Problem</h2>
                    <p>Here's the thing about detecting transcodes: not all high-frequency rolloff is compression damage.</p>
                    <p>Tape recordings roll off naturally. Vintage equipment has its own frequency curve. A legitimate lo-fi production might have no content above 15kHzâ€”but that's artistic choice, not lossy compression.</p>

                    <blockquote>
                        "MP3 has a brick-wall cutoff. Tape has gradual rolloff that varies with dynamics."
                    </blockquote>

                    <p>This observation led to CFCC: Cross-Frequency Coherence Coefficient. Instead of just looking for missing frequencies, we measure <em>how</em> they disappear.</p>

                    ${lofiNodes.length > 0 ? `
                        <p>The decision chain that led to CFCC:</p>
                        ${lofiNodes.slice(0, 3).map(n => renderDecisionCard(n, n.node_type)).join('')}
                    ` : ''}
                </section>

                <section class="chapter" id="chapter-3">
                    <span class="chapter-number">Chapter 3</span>
                    <h2>The Memory Problem</h2>
                    <p>As the codebase grew, something else became apparent: <em>decisions were getting lost.</em></p>
                    <p>Why did we choose CFCC over temporal variance analysis? What other approaches were considered and rejected? When Claude's context window filled up or the session ended, all that reasoning vanished.</p>
                    <p>The decision graph was born from this frustration. Every choice, every rejected approach, every observationâ€”captured in a queryable SQLite database that survives context loss.</p>

                    ${graphNodes.length > 0 ? `
                        <p>How the decision graph itself was built:</p>
                        ${graphNodes.slice(0, 3).map(n => renderDecisionCard(n, n.node_type)).join('')}
                    ` : ''}
                </section>

                <section class="chapter" id="chapter-4">
                    <span class="chapter-number">Chapter 4</span>
                    <h2>The Living Museum</h2>
                    <p>What started as a memory system became something more: a living document of how software evolves.</p>

                    <div class="stats-section">
                        <div class="stat-card">
                            <div class="stat-value">${totalNodes}</div>
                            <div class="stat-label">Decisions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${totalEdges}</div>
                            <div class="stat-label">Connections</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${withConfidence}</div>
                            <div class="stat-label">With Confidence</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${withCommits}</div>
                            <div class="stat-label">Linked Commits</div>
                        </div>
                    </div>

                    <p>Every node has a type: goals, decisions, options, actions, outcomes, observations. Edges show relationships: what leads to what, what was chosen, what was rejected and why.</p>
                    <p>Confidence weights track how sure we were at decision timeâ€”valuable for hindsight analysis. Commit links connect reasoning to code.</p>

                    <p>Recent activity in the graph:</p>
                    ${recentActions.map(n => renderDecisionCard(n, 'action')).join('')}
                </section>

                <section class="chapter" id="epilogue">
                    <span class="chapter-number">Epilogue</span>
                    <h2>What's Next</h2>
                    <p>The audio forensics engine works. CFCC distinguishes tape from MP3. Binary analysis catches re-encoding chains. The WASM build brings it to browsers.</p>
                    <p>But the experiment continues. Can decision graphs become a standard part of software development? Can we build tools that remember <em>why</em>, not just <em>what</em>?</p>
                    <p>The graph is public. The reasoning is queryable. The evolution continues.</p>

                    <blockquote>
                        "This isn't documentation written after the fact. It's a real-time record of how software gets built."
                    </blockquote>
                </section>
            `;

            // Highlight active TOC link on scroll
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
                        const link = document.querySelector(`.toc-link[href="#${entry.target.id}"]`);
                        if (link) link.classList.add('active');
                    }
                });
            }, { threshold: 0.3 });

            document.querySelectorAll('.chapter').forEach(ch => observer.observe(ch));
        }

        loadGraph();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Losselot - Visual Decision Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            overflow: hidden;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(22, 27, 34, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            border-bottom: 1px solid #30363d;
        }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header-links a {
            color: #58a6ff;
            text-decoration: none;
            margin-left: 24px;
            font-size: 14px;
        }
        .header-links a:hover { text-decoration: underline; }

        .controls {
            position: fixed;
            top: 70px;
            left: 20px;
            background: rgba(22, 27, 34, 0.95);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #30363d;
            z-index: 100;
            min-width: 200px;
        }
        .controls h3 { font-size: 12px; color: #8b949e; margin-bottom: 12px; text-transform: uppercase; }
        .filter-btn {
            display: inline-block;
            padding: 6px 12px;
            margin: 4px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid #30363d;
            background: transparent;
            color: #c9d1d9;
            transition: all 0.2s;
        }
        .filter-btn:hover { border-color: #58a6ff; }
        .filter-btn.active { background: #58a6ff; color: #0d1117; border-color: #58a6ff; }

        .legend {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(22, 27, 34, 0.95);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #30363d;
            z-index: 100;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
            font-size: 12px;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .node-detail {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 350px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            background: rgba(22, 27, 34, 0.95);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #30363d;
            z-index: 100;
            display: none;
        }
        .node-detail.visible { display: block; }
        .node-detail h2 { font-size: 18px; margin-bottom: 12px; line-height: 1.4; }
        .node-detail .type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .node-detail .meta { color: #8b949e; font-size: 13px; margin-bottom: 16px; }
        .node-detail .description {
            background: #161b22;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 16px;
        }
        .node-detail .connections { font-size: 13px; }
        .node-detail .conn-item {
            padding: 8px;
            background: #161b22;
            border-radius: 4px;
            margin: 6px 0;
            cursor: pointer;
        }
        .node-detail .conn-item:hover { background: #21262d; }
        .node-detail .close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            font-size: 20px;
        }

        #graph-container {
            width: 100vw;
            height: 100vh;
            padding-top: 60px;
        }

        svg { display: block; }

        .node-group { cursor: pointer; }
        .node-group:hover .node-circle { filter: brightness(1.2); }
        .node-circle {
            stroke: #30363d;
            stroke-width: 2px;
            transition: all 0.2s;
        }
        .node-circle.selected {
            stroke: #fff;
            stroke-width: 3px;
        }
        .node-label {
            font-size: 11px;
            fill: #c9d1d9;
            text-anchor: middle;
            pointer-events: none;
        }
        .node-id {
            font-size: 10px;
            fill: #fff;
            text-anchor: middle;
            font-weight: bold;
            pointer-events: none;
        }

        .edge {
            fill: none;
            stroke-width: 2px;
        }
        .edge.leads_to { stroke: #484f58; }
        .edge.chosen { stroke: #3fb950; stroke-width: 3px; }
        .edge.rejected { stroke: #f85149; stroke-dasharray: 5,5; }
        .edge.requires { stroke: #a371f7; }

        .edge-label {
            font-size: 9px;
            fill: #8b949e;
        }

        /* Node type colors */
        .node-goal { fill: #3fb950; }
        .node-decision { fill: #d29922; }
        .node-option { fill: #58a6ff; }
        .node-action { fill: #f85149; }
        .node-outcome { fill: #a371f7; }
        .node-observation { fill: #8b949e; }

        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid #30363d;
            background: rgba(22, 27, 34, 0.95);
            color: #c9d1d9;
            font-size: 20px;
            cursor: pointer;
        }
        .zoom-btn:hover { background: #21262d; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Decision Graph Visualization</h1>
        <div class="header-links">
            <a href="./">List View</a>
            <a href="../decision-graph">About</a>
            <a href="../">Home</a>
        </div>
    </div>

    <div class="controls">
        <h3>Filter by Type</h3>
        <div id="type-filters"></div>
        <h3 style="margin-top: 16px;">Focus Chain</h3>
        <select id="chain-select" style="width: 100%; padding: 8px; background: #161b22; border: 1px solid #30363d; color: #c9d1d9; border-radius: 4px;">
            <option value="all">Show All</option>
        </select>
    </div>

    <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background: #3fb950;"></div>Goal</div>
        <div class="legend-item"><div class="legend-color" style="background: #d29922;"></div>Decision</div>
        <div class="legend-item"><div class="legend-color" style="background: #58a6ff;"></div>Option</div>
        <div class="legend-item"><div class="legend-color" style="background: #f85149;"></div>Action</div>
        <div class="legend-item"><div class="legend-color" style="background: #a371f7;"></div>Outcome</div>
        <div class="legend-item"><div class="legend-color" style="background: #8b949e;"></div>Observation</div>
    </div>

    <div class="node-detail" id="node-detail">
        <button class="close-btn" onclick="closeDetail()">&times;</button>
        <div id="detail-content"></div>
    </div>

    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()">+</button>
        <button class="zoom-btn" onclick="zoomOut()">−</button>
        <button class="zoom-btn" onclick="resetZoom()">⟲</button>
    </div>

    <div id="graph-container"></div>

    <script>
        let graphData = null;
        let svg, g, zoom;
        let selectedNode = null;
        let activeFilters = new Set(['goal', 'decision', 'option', 'action', 'outcome', 'observation']);

        const nodeColors = {
            goal: '#3fb950',
            decision: '#d29922',
            option: '#58a6ff',
            action: '#f85149',
            outcome: '#a371f7',
            observation: '#8b949e'
        };

        async function loadGraph() {
            const response = await fetch('graph-data.json');
            graphData = await response.json();
            setupFilters();
            setupChainSelect();
            renderGraph();
        }

        function setupFilters() {
            const container = document.getElementById('type-filters');
            const types = ['goal', 'decision', 'option', 'action', 'outcome', 'observation'];

            container.innerHTML = types.map(t => `
                <button class="filter-btn active" data-type="${t}" onclick="toggleFilter('${t}')">${t}</button>
            `).join('');
        }

        function toggleFilter(type) {
            const btn = document.querySelector(`[data-type="${type}"]`);
            if (activeFilters.has(type)) {
                activeFilters.delete(type);
                btn.classList.remove('active');
            } else {
                activeFilters.add(type);
                btn.classList.add('active');
            }
            renderGraph();
        }

        function setupChainSelect() {
            const select = document.getElementById('chain-select');
            const goals = graphData.nodes.filter(n => n.node_type === 'goal');

            goals.forEach(goal => {
                const opt = document.createElement('option');
                opt.value = goal.id;
                opt.textContent = `#${goal.id}: ${goal.title.substring(0, 40)}...`;
                select.appendChild(opt);
            });

            select.addEventListener('change', () => {
                renderGraph(select.value === 'all' ? null : parseInt(select.value));
            });
        }

        function getDescendants(nodeId, visited = new Set()) {
            if (visited.has(nodeId)) return visited;
            visited.add(nodeId);

            const outgoing = graphData.edges.filter(e => e.from_node_id === nodeId);
            outgoing.forEach(e => getDescendants(e.to_node_id, visited));

            return visited;
        }

        function renderGraph(focusGoalId = null) {
            d3.select('#graph-container').selectAll('*').remove();

            // Filter nodes
            let nodes = graphData.nodes.filter(n => activeFilters.has(n.node_type));
            let edges = graphData.edges;

            // If focusing on a goal chain, only show descendants
            if (focusGoalId) {
                const descendants = getDescendants(focusGoalId);
                nodes = nodes.filter(n => descendants.has(n.id));
                edges = edges.filter(e => descendants.has(e.from_node_id) && descendants.has(e.to_node_id));
            }

            const nodeIds = new Set(nodes.map(n => n.id));
            edges = edges.filter(e => nodeIds.has(e.from_node_id) && nodeIds.has(e.to_node_id));

            // Create dagre graph for layout
            const dagreGraph = new dagre.graphlib.Graph();
            dagreGraph.setGraph({
                rankdir: 'TB',
                nodesep: 80,
                ranksep: 100,
                marginx: 50,
                marginy: 50
            });
            dagreGraph.setDefaultEdgeLabel(() => ({}));

            // Add nodes to dagre
            nodes.forEach(node => {
                dagreGraph.setNode(node.id, {
                    width: 120,
                    height: 50,
                    node: node
                });
            });

            // Add edges to dagre
            edges.forEach(edge => {
                dagreGraph.setEdge(edge.from_node_id, edge.to_node_id, { edge });
            });

            // Run layout
            dagre.layout(dagreGraph);

            // Get dimensions
            const graphWidth = dagreGraph.graph().width || 800;
            const graphHeight = dagreGraph.graph().height || 600;

            const container = document.getElementById('graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Create SVG
            svg = d3.select('#graph-container')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Add zoom
            zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            // Create main group
            g = svg.append('g');

            // Center the graph initially
            const initialScale = Math.min(width / (graphWidth + 100), height / (graphHeight + 100), 1);
            const initialX = (width - graphWidth * initialScale) / 2;
            const initialY = (height - graphHeight * initialScale) / 2 + 30;

            svg.call(zoom.transform, d3.zoomIdentity
                .translate(initialX, initialY)
                .scale(initialScale));

            // Draw edges
            const edgeGroup = g.append('g').attr('class', 'edges');

            dagreGraph.edges().forEach(e => {
                const edgeData = dagreGraph.edge(e);
                const edge = edgeData.edge;
                const points = edgeData.points;

                // Create path
                const line = d3.line()
                    .x(d => d.x)
                    .y(d => d.y)
                    .curve(d3.curveBasis);

                edgeGroup.append('path')
                    .attr('class', `edge ${edge.edge_type}`)
                    .attr('d', line(points))
                    .attr('marker-end', 'url(#arrowhead)');
            });

            // Add arrowhead marker
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 20)
                .attr('refY', 0)
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('fill', '#484f58');

            // Draw nodes
            const nodeGroup = g.append('g').attr('class', 'nodes');

            dagreGraph.nodes().forEach(nodeId => {
                const dagNode = dagreGraph.node(nodeId);
                const node = dagNode.node;

                const nodeG = nodeGroup.append('g')
                    .attr('class', 'node-group')
                    .attr('transform', `translate(${dagNode.x}, ${dagNode.y})`)
                    .on('click', () => showDetail(node));

                // Node circle
                nodeG.append('circle')
                    .attr('class', `node-circle node-${node.node_type}`)
                    .attr('r', 22)
                    .attr('data-id', node.id);

                // Node ID
                nodeG.append('text')
                    .attr('class', 'node-id')
                    .attr('dy', 4)
                    .text(node.id);

                // Node label (truncated)
                const label = node.title.length > 20
                    ? node.title.substring(0, 18) + '...'
                    : node.title;

                nodeG.append('text')
                    .attr('class', 'node-label')
                    .attr('dy', 40)
                    .text(label);
            });
        }

        function showDetail(node) {
            selectedNode = node;

            // Highlight selected
            d3.selectAll('.node-circle').classed('selected', false);
            d3.select(`.node-circle[data-id="${node.id}"]`).classed('selected', true);

            const incoming = graphData.edges.filter(e => e.to_node_id === node.id);
            const outgoing = graphData.edges.filter(e => e.from_node_id === node.id);

            const getNode = id => graphData.nodes.find(n => n.id === id);

            document.getElementById('detail-content').innerHTML = `
                <div class="type-badge" style="background: ${nodeColors[node.node_type]}">${node.node_type}</div>
                <h2>${node.title}</h2>
                <div class="meta">
                    Node #${node.id} · ${node.status} · ${new Date(node.created_at).toLocaleDateString()}
                </div>
                ${node.description ? `<div class="description">${node.description}</div>` : ''}

                ${incoming.length > 0 ? `
                    <div class="connections">
                        <strong>From (${incoming.length})</strong>
                        ${incoming.map(e => {
                            const from = getNode(e.from_node_id);
                            return `<div class="conn-item" onclick="navigateTo(${e.from_node_id})">
                                <span style="color: ${nodeColors[from.node_type]}">●</span>
                                #${from.id}: ${from.title.substring(0, 30)}...
                                <br><small style="color: #8b949e">${e.edge_type}${e.rationale ? ': ' + e.rationale : ''}</small>
                            </div>`;
                        }).join('')}
                    </div>
                ` : ''}

                ${outgoing.length > 0 ? `
                    <div class="connections" style="margin-top: 16px;">
                        <strong>To (${outgoing.length})</strong>
                        ${outgoing.map(e => {
                            const to = getNode(e.to_node_id);
                            return `<div class="conn-item" onclick="navigateTo(${e.to_node_id})">
                                <span style="color: ${nodeColors[to.node_type]}">●</span>
                                #${to.id}: ${to.title.substring(0, 30)}...
                                <br><small style="color: #8b949e">${e.edge_type}${e.rationale ? ': ' + e.rationale : ''}</small>
                            </div>`;
                        }).join('')}
                    </div>
                ` : ''}
            `;

            document.getElementById('node-detail').classList.add('visible');
        }

        function navigateTo(nodeId) {
            const node = graphData.nodes.find(n => n.id === nodeId);
            if (node) showDetail(node);
        }

        function closeDetail() {
            document.getElementById('node-detail').classList.remove('visible');
            d3.selectAll('.node-circle').classed('selected', false);
            selectedNode = null;
        }

        function zoomIn() {
            svg.transition().call(zoom.scaleBy, 1.3);
        }

        function zoomOut() {
            svg.transition().call(zoom.scaleBy, 0.7);
        }

        function resetZoom() {
            const container = document.getElementById('graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            svg.transition().call(zoom.transform, d3.zoomIdentity
                .translate(width / 2, height / 2)
                .scale(0.5));
        }

        loadGraph();
    </script>
</body>
</html>
